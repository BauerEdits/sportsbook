<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Betting App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family:Arial,sans-serif;margin:20px }
    .hidden { display:none }
    .container { margin-bottom:20px }
    .line-block { border:1px solid #ddd; padding:10px; margin-bottom:10px }
    .option-btn { margin-right:5px;padding:5px 10px; }
    .selected { background:lightgreen }
    table,th,td { border:1px solid #ccc;border-collapse:collapse;padding:5px }
    a { color:blue;text-decoration:underline;cursor:pointer }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginSection" class="container">
    <h2>Login</h2>
    <form id="loginForm">
      <label>Username:</label>
      <input id="loginUsername" required /><br/>
      <label>Password:</label>
      <input type="password" id="loginPassword" required /><br/>
      <button type="submit">Login</button>
    </form>
    <p id="loginMessage" style="color:red"></p>
    <p>Don't have an account? <a id="showSignup">Sign Up</a></p>
  </div>

  <!-- SIGNUP -->
  <div id="signupSection" class="container hidden">
    <h2>Sign Up</h2>
    <form id="signupForm">
      <label>Username:</label>
      <input id="signupUsername" required /><br/>
      <label>Password:</label>
      <input type="password" id="signupPassword" required /><br/>
      <label>Confirm:</label>
      <input type="password" id="signupConfirm" required /><br/>
      <label>Role:</label>
      <select id="signupRole">
        <option value="member">Member</option>
        <option value="admin">Admin</option>
      </select><br/>
      <button type="submit">Sign Up</button>
    </form>
    <p id="signupMessage" style="color:red"></p>
    <p>Already have an account? <a id="showLogin">Log In</a></p>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="container hidden">
    <h2>Admin Dashboard</h2>
    <button id="logoutAdmin">Logout</button>

    <h3>Create Line</h3>
    <form id="createLineForm" class="line-block">
      <input id="lineDesc" placeholder="Description" required />
      <input id="opt1" placeholder="Option 1" required />
      <input id="opt2" placeholder="Option 2" required />
      <button type="submit">Create</button>
    </form>

    <h3>Manage Lines</h3>
    <div id="linesContainer"></div>

    <h3>Live Plays</h3>
    <div id="livePlaysContainer"></div>

    <h3>Past Plays</h3>
    <div id="pastPlaysContainer"></div>

    <button id="resolveBetsBtn">Resolve Unsettled Bets</button>
  </div>

  <!-- MEMBER DASHBOARD -->
  <div id="memberDashboard" class="container hidden">
    <h2>Member Dashboard</h2>
    <button id="logoutMember">Logout</button>
    <div id="bonusSection" style="margin:10px 0"></div>

    <h3>Available Lines</h3>
    <div id="availableLines"></div>

    <form id="placeBetForm">
      <label>Bet Amount:</label>
      <input type="number" step="0.01" id="betAmt" required /><br/>
      <p id="payoutDisplay">Potential Payout: N/A</p>
      <button type="submit">Place Bet</button>
    </form>

    <h3>Live Bets</h3>
    <div id="liveBetsContainer"></div>

    <h3>Past Bets</h3>
    <div id="pastBetsContainer"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const MULT = {2:3,3:7,4:10,5:12,6:25};
  let lines = [], bets = [], pending = {}, current = null, userRef = null;

  function show(id,on){
    document.getElementById(id).classList[on?'remove':'add']('hidden');
  }

  // Initialize Firebase
  firebase.initializeApp({
    apiKey: "AIzaSyBfS12-iZ4ANoBuXPJWoMNvs8F94BARU54",
    authDomain: "gambling-1e67c.firebaseapp.com",
    databaseURL: "https://gambling-1e67c-default-rtdb.firebaseio.com",
    projectId: "gambling-1e67c",
    storageBucket: "gambling-1e67c.firebasestorage.app",
    messagingSenderId: "233258255069",
    appId: "1:233258255069:web:7f844c31c3664408dd5134",
    measurementId: "G-9HFLW7KVYW"
  });
  const db = firebase.database();

  // Local users/session
  const UKEY="bet_users";
  function loadU(){ return JSON.parse(localStorage.getItem(UKEY))||[]; }
  function saveU(u){ localStorage.setItem(UKEY,JSON.stringify(u)); }
  function initU(){
    let u=loadU();
    if(!u.some(x=>x.username==="admin")){
      u.push({id:1,username:"admin",password:"admin123",role:"admin"});
      saveU(u);
    }
  }
  initU();

  function saveSession(){ localStorage.currentUser = JSON.stringify(current); }
  function clearSession(){ localStorage.removeItem("currentUser"); }
  function genId(arr){ return arr.length?Math.max(...arr.map(x=>x.id))+1:1; }
  function today(){ return new Date().toISOString().split("T")[0]; }
  function ensureBal(u){
    if(u.role==="member" && u.balance==null) u.balance=1000;
    return u;
  }

  // Realtime listeners
  db.ref("lines").on("value", snap=>{
    lines = Object.entries(snap.val()||{}).map(([id,o])=>({...o,id}));
    renderAdmin(); renderMember();
  });
  db.ref("bets").on("value", snap=>{
    bets = Object.entries(snap.val()||{}).map(([id,o])=>({...o,id}));
    renderAdmin(); renderMember();
  });

  // Add line/bet
  function addLine(l){ return db.ref("lines").push().set(l); }
  function addBet(b){ return db.ref("bets").push().set(b); }

  // Balance stored in Firebase under /users/{username}
  function writeUserBalance(username, balance, lastClaimDate){
    db.ref('users/'+username).set({ balance, lastClaimDate });
  }
  function updateUserBalance(username, amt){
    const r = db.ref('users/'+username+'/balance');
    r.transaction(old=> (old||0) + amt);
  }

  // LOGIN
  document.getElementById("loginForm").addEventListener('submit', e=>{
    e.preventDefault();
    const un=document.getElementById("loginUsername").value.trim(),
          pw=document.getElementById("loginPassword").value;
    const user = loadU().find(u=>u.username===un&&u.password===pw);
    if(!user){
      document.getElementById("loginMessage").textContent="Invalid credentials.";
      return;
    }
    current = (user.role==="member" ? ensureBal(user) : user);
    saveSession();

    // Subscribe to /users/{username}
    if(userRef) userRef.off();
    userRef = db.ref('users/'+current.username);
    userRef.once('value', snap=>{
      if(!snap.exists()){
        writeUserBalance(current.username, current.balance, current.lastClaimDate||"");
      } else {
        const d=snap.val();
        current.balance = d.balance;
        current.lastClaimDate = d.lastClaimDate||"";
        saveSession();
      }
      renderMember();
    });
    userRef.on('value', snap=>{
      const d=snap.val();
      if(d){
        current.balance = d.balance;
        current.lastClaimDate = d.lastClaimDate||"";
        saveSession();
        renderMember();
      }
    });

    show("loginSection",false);
    show("signupSection",false);
    if(current.role==="admin"){
      show("adminDashboard",true);
      renderAdmin();
    } else {
      show("memberDashboard",true);
      renderMember();
    }
  });

  // SIGNUP
  document.getElementById("signupForm").addEventListener('submit', e=>{
    e.preventDefault();
    const un=document.getElementById("signupUsername").value.trim(),
          pw=document.getElementById("signupPassword").value,
          cp=document.getElementById("signupConfirm").value,
          rl=document.getElementById("signupRole").value;
    if(pw!==cp){
      document.getElementById("signupMessage").textContent="Passwords do not match.";
      return;
    }
    let ul=loadU();
    if(rl==="admin"){
      document.getElementById("signupMessage").textContent="Admin exists.";
      return;
    }
    if(ul.some(x=>x.username===un)){
      document.getElementById("signupMessage").textContent="Username taken.";
      return;
    }
    const nu={id:genId(ul),username:un,password:pw,role:"member",balance:1000,lastClaimDate:""};
    ul.push(nu); saveU(ul);
    writeUserBalance(nu.username,nu.balance,nu.lastClaimDate);

    current=nu; saveSession();
    if(userRef) userRef.off();
    userRef = db.ref('users/'+current.username);
    userRef.on('value', snap=>{
      const d=snap.val();
      if(d){
        current.balance = d.balance;
        current.lastClaimDate = d.lastClaimDate;
        saveSession();
        renderMember();
      }
    });

    show("signupSection",false);
    show("memberDashboard",true);
    renderMember();
  });

  // LOGOUT
  document.getElementById("logoutAdmin").addEventListener('click', ()=>{
    clearSession();
    if(userRef) userRef.off();
    show("adminDashboard",false);
    show("loginSection",true);
  });
  document.getElementById("logoutMember").addEventListener('click', ()=>{
    clearSession();
    if(userRef) userRef.off();
    show("memberDashboard",false);
    show("loginSection",true);
  });

  // Toggle login/signup links
  document.getElementById("showSignup").addEventListener('click', ()=>{
    show("loginSection",false);
    show("signupSection",true);
  });
  document.getElementById("showLogin").addEventListener('click', ()=>{
    show("signupSection",false);
    show("loginSection",true);
  });

  // Resolve bets only when Admin clicks
  document.getElementById("resolveBetsBtn").addEventListener('click', async ()=>{
    for(const b of bets){
      if(b.isSettled) continue;
      // skip if any leg still pending
      if(b.selections.some(sel=>{
        const ln=lines.find(l=>l.id===sel.lineId);
        return !ln||ln.correctOption==null;
      })) continue;
      const results = b.selections.map(sel=>{
        const ln=lines.find(l=>l.id===sel.lineId);
        return Number(sel.choice)===Number(ln.correctOption);
      });
      b.isSettled   = true;
      b.results     = results;
      b.resolvedAt  = new Date().toLocaleString();
      b.isWon       = results.every(r=>r);
      b.payout      = b.isWon ? b.betAmount*(MULT[b.selections.length]||1) : 0;
      if(b.isWon){
        updateUserBalance(b.user,b.payout);
      }
      await db.ref('bets/'+b.id).update({
        isSettled:b.isSettled,
        results:b.results,
        resolvedAt:b.resolvedAt,
        isWon:b.isWon,
        payout:b.payout
      });
    }
    renderAdmin();
    renderMember();
  });

  // Renders (identical to before)
  function renderAdmin(){ /* ...same as your code above... */ }
  function renderMember(){ /* ...same as your code above... */ }

  // Selection & place bet logic (same as before)
  window.toggle = (id,ch)=>{
    if(pending[id]===ch) delete pending[id];
    else pending[id]=ch;
    renderMember();
  };
  function updatePotential(){
    const cnt=Object.keys(pending).length,
          amt=parseFloat(document.getElementById("betAmt").value),
          pd=document.getElementById("payoutDisplay");
    pd.innerText =
      (!isNaN(amt)&&amt>0&&cnt>=2&&cnt<=6&&MULT[cnt])
        ? "Potential Payout: $"+(amt*MULT[cnt]).toFixed(2)
        : "Potential Payout: N/A";
  }
  document.getElementById("betAmt").addEventListener('input',updatePotential);

  document.getElementById("createLineForm").addEventListener('submit', e=>{
    e.preventDefault();
    const d=document.getElementById("lineDesc").value.trim(),
          o1=document.getElementById("opt1").value.trim(),
          o2=document.getElementById("opt2").value.trim();
    if(d&&o1&&o2){
      addLine({description:d,option1:o1,option2:o2,correctOption:null})
        .then(_=>e.target.reset());
    }
  });

  document.getElementById("placeBetForm").addEventListener('submit', async e=>{
    e.preventDefault();
    const amt = parseFloat(document.getElementById("betAmt").value);
    if(amt>current.balance){ alert("Insufficient balance"); return; }
    const sels = Object.entries(pending).map(([id,ch])=>({ lineId:id, choice:ch }));
    if(sels.length<2||sels.length>6){ alert("Pick 2â€“6 lines"); return; }
    // deduct and write back to Firebase
    updateUserBalance(current.username, -amt);
    await addBet({
      betAmount:amt,
      user:current.username,
      selections:sels,
      isSettled:false,
      isWon:null,
      payout:null,
      createdAt:new Date().toLocaleString(),
      resolvedAt:null
    });
    pending={};
    e.target.reset();
    renderMember();
  });

});
</script>
</body>
</html>
