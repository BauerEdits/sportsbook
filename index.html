<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Betting App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family:Arial,sans-serif; margin:20px }
    .hidden { display:none }
    .container { margin-bottom:20px }
    .line-block { border:1px solid #ddd; padding:10px; margin-bottom:10px }
    .option-btn { margin-right:5px; padding:5px 10px; }
    .selected { background:lightgreen }
    table,th,td { border:1px solid #ccc; border-collapse:collapse; padding:5px }
    a { color:blue; text-decoration:underline; cursor:pointer }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginSection" class="container">
    <h2>Login</h2>
    <form id="loginForm">
      <label>Username:</label>
      <input id="loginUsername" required /><br/>
      <label>Password:</label>
      <input type="password" id="loginPassword" required /><br/>
      <button type="submit">Login</button>
    </form>
    <p id="loginMessage" style="color:red"></p>
    <p>Don't have an account? <a id="showSignup">Sign Up</a></p>
  </div>

  <!-- SIGNUP -->
  <div id="signupSection" class="container hidden">
    <h2>Sign Up</h2>
    <form id="signupForm">
      <label>Username:</label>
      <input id="signupUsername" required /><br/>
      <label>Password:</label>
      <input type="password" id="signupPassword" required /><br/>
      <label>Confirm:</label>
      <input type="password" id="signupConfirm" required /><br/>
      <label>Role:</label>
      <select id="signupRole">
        <option value="member">Member</option>
        <option value="admin">Admin</option>
      </select><br/>
      <button type="submit">Sign Up</button>
    </form>
    <p id="signupMessage" style="color:red"></p>
    <p>Already have an account? <a id="showLogin">Log In</a></p>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="container hidden">
    <h2>Admin Dashboard</h2>
    <button id="logoutAdmin">Logout</button>

    <h3>Create Line</h3>
    <form id="createLineForm" class="line-block">
      <input id="lineDesc" placeholder="Description" required />
      <input id="opt1" placeholder="Option 1" required />
      <input id="opt2" placeholder="Option 2" required />
      <button type="submit">Create</button>
    </form>

    <h3>Manage Lines</h3>
    <div id="linesContainer"></div>

    <h3>Live Plays</h3>
    <div id="livePlaysContainer"></div>

    <h3>Past Plays</h3>
    <div id="pastPlaysContainer"></div>

    <button id="resolveBetsBtn">Resolve Unsettled Bets</button>
  </div>

  <!-- MEMBER DASHBOARD -->
  <div id="memberDashboard" class="container hidden">
    <h2>Member Dashboard</h2>
    <button id="logoutMember">Logout</button>
    <div id="bonusSection" style="margin:10px 0"></div>

    <h3>Available Lines</h3>
    <div id="availableLines"></div>

    <form id="placeBetForm">
      <label>Bet Amount:</label>
      <input type="number" step="0.01" id="betAmt" required /><br/>
      <p id="payoutDisplay">Potential Payout: N/A</p>
      <button type="submit">Place Bet</button>
    </form>

    <h3>Live Bets</h3>
    <div id="liveBetsContainer"></div>

    <h3>Past Bets</h3>
    <div id="pastBetsContainer"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const MULT = {2:3,3:7,4:10,5:12,6:25};
  let lines = [], bets = [], pending = {}, currentSession = null, userRef = null;

  const UKEY    = 'bet_users';
  const SESSKEY = 'current_session';

  // show/hide helper
  const show = (id,on) =>
    document.getElementById(id).classList[on?'remove':'add']('hidden');

  // Firebase init
  firebase.initializeApp({
    apiKey: "...",
    authDomain: "...",
    databaseURL: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "...",
    measurementId: "..."
  });
  const db = firebase.database();

  // localStorage users/session
  function loadUsers(){ return JSON.parse(localStorage.getItem(UKEY))||[]; }
  function saveUsers(u){ localStorage.setItem(UKEY,JSON.stringify(u)); }
  function loadSession(){ return JSON.parse(localStorage.getItem(SESSKEY)); }
  function saveSession(s){ localStorage.setItem(SESSKEY,JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(SESSKEY); }

  // ensure admin exists
  (()=>{
    let u=loadUsers();
    if(!u.find(x=>x.username==='admin')){
      u.push({id:1,username:'admin',password:'admin123',role:'admin'});
      saveUsers(u);
    }
  })();

  // helpers
  const genId = arr=> arr.length? Math.max(...arr.map(x=>x.id))+1:1;
  const today = ()=> new Date().toISOString().split('T')[0];

  // write initial user data if missing
  function ensureUserNode(u){
    db.ref('users/'+u.username).once('value',snap=>{
      if(!snap.exists()){
        db.ref('users/'+u.username).set({balance:1000,lastClaimDate:""});
      }
    });
  }

  // on login or signup, subscribe to user's balance
  function watchBalance(username){
    if(userRef) userRef.off();
    userRef = db.ref('users/'+username);
    userRef.on('value',snap=>{
      const d = snap.val()||{};
      currentSession.balance      = d.balance||0;
      currentSession.lastClaimDate= d.lastClaimDate||"";
      saveSession(currentSession);
      renderMember();
    });
  }

  // update balance via transaction
  function updateBalance(username, delta){
    const r = db.ref('users/'+username+'/balance');
    r.transaction(old=>(old||0)+delta);
  }

  // globals
  lines = [];
  bets  = [];

  // realtime listeners
  db.ref('lines').on('value',snap=>{
    lines = Object.entries(snap.val()||{}).map(([id,o])=>({...o,id}));
    renderAdmin(); renderMember();
  });
  db.ref('bets').on('value',snap=>{
    bets = Object.entries(snap.val()||{}).map(([id,o])=>({...o,id}));
    renderAdmin(); renderMember();
  });

  // restore session if any
  currentSession = loadSession();
  if(currentSession){
    show('loginSection',false);
    show('signupSection',false);
    if(currentSession.role==='admin'){
      show('adminDashboard',true);
      renderAdmin();
    } else {
      show('memberDashboard',true);
      ensureUserNode(currentSession);
      watchBalance(currentSession.username);
    }
  }

  // toggle forms
  document.getElementById('showSignup').onclick=()=>{
    show('loginSection',false);
    show('signupSection',true);
  };
  document.getElementById('showLogin').onclick=()=>{
    show('signupSection',false);
    show('loginSection',true);
  };

  // LOGIN
  document.getElementById('loginForm').onsubmit=e=>{
    e.preventDefault();
    const un=document.getElementById('loginUsername').value.trim(),
          pw=document.getElementById('loginPassword').value;
    let u = loadUsers().find(x=>x.username===un&&x.password===pw);
    if(!u){
      document.getElementById('loginMessage').textContent='Invalid credentials.';
      return;
    }
    currentSession = {username:u.username,role:u.role};
    saveSession(currentSession);
    show('loginSection',false);
    show('signupSection',false);
    if(u.role==='admin'){
      show('adminDashboard',true);
      renderAdmin();
    } else {
      show('memberDashboard',true);
      ensureUserNode(u);
      watchBalance(u.username);
    }
  };

  // SIGNUP
  document.getElementById('signupForm').onsubmit=e=>{
    e.preventDefault();
    const un=document.getElementById('signupUsername').value.trim(),
          pw=document.getElementById('signupPassword').value,
          cp=document.getElementById('signupConfirm').value,
          rl=document.getElementById('signupRole').value;
    if(pw!==cp){
      document.getElementById('signupMessage').textContent='Passwords do not match.';
      return;
    }
    let ul=loadUsers();
    if(rl==='admin'){
      document.getElementById('signupMessage').textContent='Admin exists.';
      return;
    }
    if(ul.find(x=>x.username===un)){
      document.getElementById('signupMessage').textContent='Username taken.';
      return;
    }
    const nu={id:genId(ul),username:un,password:pw,role:'member'};
    ul.push(nu); saveUsers(ul);
    currentSession = {username:un,role:'member'};
    saveSession(currentSession);
    ensureUserNode(currentSession);
    watchBalance(currentSession.username);
    show('signupSection',false);
    show('memberDashboard',true);
  };

  // LOGOUT
  document.getElementById('logoutAdmin').onclick=()=>{
    clearSession();
    show('adminDashboard',false);
    show('loginSection',true);
  };
  document.getElementById('logoutMember').onclick=()=>{
    clearSession();
    if(userRef) userRef.off();
    show('memberDashboard',false);
    show('loginSection',true);
  };

  // CREATE LINE
  document.getElementById('createLineForm').onsubmit=e=>{
    e.preventDefault();
    const d=document.getElementById('lineDesc').value.trim(),
          o1=document.getElementById('opt1').value.trim(),
          o2=document.getElementById('opt2').value.trim();
    if(!d||!o1||!o2) return;
    db.ref('lines').push().set({description:d,option1:o1,option2:o2,correctOption:null})
      .then(_=>e.target.reset());
  };

  // PLACE BET
  document.getElementById('placeBetForm').onsubmit=async e=>{
    e.preventDefault();
    const amt=parseFloat(document.getElementById('betAmt').value);
    if(amt>currentSession.balance){ alert('Insufficient'); return; }
    const sels=Object.entries(pending).map(([id,ch])=>({lineId:id,choice:ch}));
    if(sels.length<2||sels.length>6){ alert('Pick 2–6 lines'); return; }
    // deduct immediately
    updateBalance(currentSession.username,-amt);
    // write bet
    await db.ref('bets').push().set({
      betAmount:amt,
      user:currentSession.username,
      selections:sels,
      isSettled:false,
      isWon:null,
      payout:null,
      createdAt:new Date().toLocaleString(),
      resolvedAt:null
    });
    pending={};
    e.target.reset();
    renderMember();
  };

  // Resolve Unsettled Bets
  document.getElementById('resolveBetsBtn').onclick=async ()=>{
    for(let b of bets){
      if(b.isSettled) continue;
      // skip if any selection still pending
      if(b.selections.some(sel=>{
        const ln=lines.find(l=>l.id===sel.lineId);
        return !ln||ln.correctOption==null;
      })) continue;
      // mark results
      const results=b.selections.map(sel=>{
        const ln=lines.find(l=>l.id===sel.lineId);
        return Number(sel.choice)===Number(ln.correctOption);
      });
      const won = results.every(x=>x);
      const payout = won? b.betAmount*(MULT[b.selections.length]||1):0;
      if(won) updateBalance(b.user,payout);
      await db.ref('bets/'+b.id).update({
        isSettled:true,
        results,
        isWon:won,
        payout,
        resolvedAt:new Date().toLocaleString()
      });
    }
    renderAdmin();
    renderMember();
  };

  // toggle selections
  window.toggle=(id,ch)=>{
    if(pending[id]===ch) delete pending[id];
    else pending[id]=ch;
    renderMember();
  };

  // update potential display
  document.getElementById('betAmt').oninput=()=>{
    const cnt=Object.keys(pending).length,
          amt=parseFloat(document.getElementById('betAmt').value),
          pd=document.getElementById('payoutDisplay');
    pd.innerText = (!isNaN(amt)&&amt>0&&cnt>=2&&cnt<=6&&MULT[cnt])
      ? 'Potential Payout: $'+(amt*MULT[cnt]).toFixed(2)
      : 'Potential Payout: N/A';
  };

  // RENDER ADMIN
  function renderAdmin(){
    // Lines
    const lc=document.getElementById('linesContainer');
    if(!lines.length) lc.innerHTML='<p>No lines.</p>';
    else {
      let h=`<table>
        <tr><th>ID</th><th>Desc</th><th>O1</th><th>O2</th><th>Status</th><th>Actions</th></tr>`;
      for(const l of lines){
        const st = l.correctOption==null
                 ? 'Pending'
                 : (l.correctOption===1?l.option1:l.option2);
        h+=`<tr>
          <td>${l.id}</td><td>${l.description}</td><td>${l.option1}</td>
          <td>${l.option2}</td><td>${st}</td>
          <td>
            <button onclick="db.ref('lines/${l.id}').update({correctOption:1})">Set1</button>
            <button onclick="db.ref('lines/${l.id}').update({correctOption:2})">Set2</button>
            <button onclick="db.ref('lines/${l.id}').remove()">Del</button>
            <button onclick="db.ref('lines/${l.id}').update({correctOption:null})">Reuse</button>
          </td>
        </tr>`;
      }
      lc.innerHTML=h+'</table>';
    }
    // Live
    const lp=document.getElementById('livePlaysContainer'),
          live=bets.filter(b=>!b.isSettled);
    if(!live.length) lp.innerHTML='<p>No live plays.</p>';
    else {
      let h=`<table>
        <tr><th>ID</th><th>User</th><th>Amt</th><th>Sel</th><th>On</th></tr>`;
      for(const b of live){
        const s=b.selections.map(sel=>{
          const ln=lines.find(x=>x.id===sel.lineId);
          return ln?`${ln.description}(${sel.choice===1?ln.option1:ln.option2})`:'';
        }).join(' | ');
        h+=`<tr>
          <td>${b.id}</td><td>${b.user}</td><td>${b.betAmount}</td>
          <td>${s}</td><td>${b.createdAt}</td>
        </tr>`;
      }
      lp.innerHTML=h+'</table>';
    }
    // Past
    const pp=document.getElementById('pastPlaysContainer'),
          past=bets.filter(b=>b.isSettled);
    if(!past.length) pp.innerHTML='<p>No past plays.</p>';
    else {
      let h=`<table>
        <tr><th>ID</th><th>User</th><th>Amt</th><th>Res</th>
            <th>Status</th><th>Pay</th><th>On</th></tr>`;
      for(const b of past){
        const rs=b.results.map(r=>r?'✓':'✗').join(' ');
        h+=`<tr>
          <td>${b.id}</td><td>${b.user}</td><td>${b.betAmount}</td>
          <td>${rs}</td><td>${b.isWon?'Won':'Lost'}</td>
          <td>${b.payout}</td><td>${b.resolvedAt}</td>
        </tr>`;
      }
      pp.innerHTML=h+'</table>';
    }
  }

  // RENDER MEMBER
  function renderMember(){
    if(!currentSession) return;
    // Bonus & Balance
    const bs=document.getElementById('bonusSection'),
          td=today();
    if(!currentSession.lastClaimDate||currentSession.lastClaimDate!==td){
      bs.innerHTML=`Balance: $${currentSession.balance.toFixed(2)} 
        <button id="claimB">Claim $5</button>`;
      document.getElementById('claimB').onclick=()=>{
        updateBalance(currentSession.username,5);
        db.ref('users/'+currentSession.username+'/lastClaimDate').set(td);
      };
    } else {
      bs.innerHTML=`Balance: $${currentSession.balance.toFixed(2)} 
        <button disabled>Claimed</button>`;
    }
    // Available lines
    const av=document.getElementById('availableLines'),
          al=lines.filter(l=>l.correctOption==null);
    if(!al.length) av.innerHTML='<p>No available lines.</p>';
    else av.innerHTML=al.map(l=>{
      const c1=pending[l.id]===1?'option-btn selected':'option-btn',
            c2=pending[l.id]===2?'option-btn selected':'option-btn';
      return `<div class="line-block">
        <strong>${l.description}</strong><br/>
        <button class="${c1}" onclick="toggle('${l.id}',1)">${l.option1}</button>
        <button class="${c2}" onclick="toggle('${l.id}',2)">${l.option2}</button>
      </div>`;
    }).join('');
    updatePotential();
    // Live bets
    const lv=document.getElementById('liveBetsContainer'),
          ml=bets.filter(b=>b.user===currentSession.username&&!b.isSettled);
    if(!ml.length) lv.innerHTML='<p>No live bets.</p>';
    else {
      let h=`<table>
        <tr><th>ID</th><th>Amt</th><th>Sel</th><th>On</th></tr>`;
      for(const b of ml){
        const s=b.selections.map(sel=>{
          const ln=lines.find(x=>x.id===sel.lineId);
          return ln?`${ln.description}(${sel.choice===1?ln.option1:ln.option2})`:'';
        }).join(' | ');
        h+=`<tr>
          <td>${b.id}</td><td>${b.betAmount}</td><td>${s}</td><td>${b.createdAt}</td>
        </tr>`;
      }
      lv.innerHTML=h+'</table>';
    }
    // Past bets
    const pv=document.getElementById('pastPlaysContainer'),
          pm=bets.filter(b=>b.user===currentSession.username&&b.isSettled);
    if(!pm.length) pv.innerHTML='<p>No past bets.</p>';
    else {
      let h=`<table>
        <tr><th>ID</th><th>Amt</th><th>Res</th><th>Status</th>
            <th>Pay</th><th>On</th></tr>`;
      for(const b of pm){
        const rs=b.results.map(r=>r?'✓':'✗').join(' ');
        h+=`<tr>
          <td>${b.id}</td><td>${b.betAmount}</td><td>${rs}</td>
          <td>${b.isWon?'Won':'Lost'}</td><td>${b.payout}</td><td>${b.resolvedAt}</td>
        </tr>`;
      }
      pv.innerHTML=h+'</table>';
    }
  }
});
</script>
</body>
</html>
